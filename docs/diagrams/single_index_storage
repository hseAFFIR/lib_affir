@startuml
start

:Input: Массив троек <токен, id файла, позиция вхождения>;
if (Существует в структуре) then (Нет)
  :Найти новый блок в файле;
  :Добавить токен и его позиции\nв хранилище;
else (Да)
  if (Размер блока достаточен?) then  (Нет)
    :Освободить текущий блок;
    :Найти существующий\nсвободный блок\n подходящего размера\nили выделить такой;
    :Скопировать текущие позиции\nв новый блок;
    :Дописать новые позиции\nв этот же блок;
  else (Да)
    :Добавить новые позиции\nв существующий блок\nк нужному токену;
  endif
endif

stop
@enduml